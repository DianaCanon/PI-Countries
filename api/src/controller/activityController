const axios = require("axios");
const { Country } = require("../db");

const dbCountry = async () => {
  const dbfind = await Country.findAll();

  if (dbfind.length) return dbfind;
  else {
    const result = await axios.get("https://restcountries.com/v3/all");
    const arrayDatos = result.data;

    if (!arrayDatos.length) return "datos no encontrados";

    arrayDatos.forEach(async (c) => {
      const idRepetido = await Country.findByPk(c.cca3);

      if (idRepetido === null) {
        let objCountry = {};
        objCountry.IdCountry = c.cca3;
        objCountry.Nombre = c.name.common;
        objCountry.Imagen_bandera = c.flags[1];
        objCountry.Capital = c.capital ? c.capital[0] : "Capital no encontrada";
        objCountry.Subregión = c.subregion;
        objCountry.Área = c.area;
        objCountry.Población = c.population;
        const countries = await Country.create(objCountry);
      }
    });
    const dbfind = await Country.findAll();
    return dbfind;
  }
};

module.exports = { dbCountry };
