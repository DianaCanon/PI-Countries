const axios = require("axios");
const { Op } = require("sequelize");
const { Country, Activity } = require("../db");

const clearData = (data) => {
  return data.map((c) => {
    return {
      IdCountry: c.cca3,
      nombre: c.name.common,
      img_bandera: c.flags[1],
      capital: c.capital ? c.capital[0] : "Capital no encontrada",
      subregion: c.subregion,
      area: c.area,
      poblacion: c.population,
    };
  });
};

const dbCountry = async () => {
  const dbCountries = await Country.findAll();
  if (dbCountries.length > 0) return dbCountries;
  else {
    const result = (await axios.get("https://restcountries.com/v3/all")).data;
    const dataclean = clearData(result);
    await Country.bulkCreate(dataclean);

    return await Country.findAll();
  }
};

const getCountryById = async (id) => {
  return await Country.findByPk(id, {
    include: [
      {
        model: Activity,
      },
    ],
  });
};

const dbCountriesByName = async (name) => {
  const findName = await Country.findAll({
    where: {
      nombre: {
        [Op.iLike]: `%${name}%`,
      },
    },
  });
  return findName;
};

module.exports = { dbCountry, dbCountriesByName, getCountryById };
